#!/bin/bash

set -ex

sed -i '/^search/d' /etc/resolvconf/resolv.conf.d/tail
export UPDATEDAYS=7d

<% if_p("search") do |domain| %>
echo "search <%= domain %>" >> /etc/resolvconf/resolv.conf.d/tail
<% end %>

/sbin/resolvconf -u

update_dns () {
export ADDR=$(/sbin/ifconfig eth0 | grep 'inet addr' | awk '{print $2}' | sed -e s/.*://)
export HOST=$(hostname)
export DNSSERVER=$(cat /etc/resolv.conf | grep -i nameserver | sed -n 2p | awk '{print $2}')

<% if_p("search") do |domain| %>
    echo "server $DNSSERVER
update add $HOST.<%= domain %> 1800 IN A $ADDR
send
quit
" > /tmp/nsupdate.txt
    nsupdate /tmp/nsupdate.txt

<% end %>

}

while true; do
    update_dns
    sleep $UPDATEDAYS
done
